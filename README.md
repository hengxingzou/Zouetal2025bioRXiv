This repository contains data for the manuscript, **Hyper-dominant species drive unexpected functional shifts in North American birds**, by Heng-Xing Zou, Adam C. Smith, Kai Zhu, and Brian C. Weeks. Heng-Xing Zou curated and analyzed the data using the code provided in the repository.

# Overview

This repository contains the following directories:

`1_FitModels` contains the code for fitting abundance models for each species.
`2_GenerateCommunityData` contains the code for generating data on a local community level (one by one degree latitude and longitude), including community composition, community-weighted means (CWMs), human-induced land use changes, and bioclimatic data.
`3_Analysis` contains all code used for analyses in the manuscript.

`Database` contains all data used in the analyses. 
`GeneratedData` contains data generated by code in `2_GenerateCommunityData` and `3_Analysis` that support the analyses.
`Figures` and `Stats` are a blank directories that will host figures generated by code in `3_Analysis`. 
`Model_Fitting_Output`, `Diagnostics`, and `Indices` are blank directories that host output from the code in `1_FitModels`.

# Data Source

**Bird Species Abundances.** Species abundance data were obtained from the North American Breeding Bird Survey (publicly available at the [USGS website](https://www.usgs.gov/centers/eesc/science/north-american-breeding-bird-survey); also available to download with the package [`bbsBayes2`](https://bbsbayes.github.io/bbsBayes2/index.html)). The analysis uses the 2022 release of the data. See `Database/BBS_List_PIF.csv` for the full species list. The PIF adjustment factors correct species abundances based on their detectability under the NABBS protocol and was supplied by Adam C. Smith. 

**Functional Traits.** Functional trait data were obtained from various sources, including [AVONET](https://doi.org/10.1111/ele.13898), [EltonTraits 1.0](https://doi.org/10.1890/13-1917.1), [Myhrvold et al.](https://doi.org/10.1890/15-0846R.1), [Chia et al.](https://www.nature.com/articles/s41597-023-02837-1), and [Bird et al.](https://doi.org/10.1111/cobi.13486). We did not use all functional traits but kept them in the data file for code compatibility. See the manuscript for the traits used and appropriate citations.

**Bioclimatic Data.** Bioclimatic data were obtained from [WorldClim2](https://rmets.onlinelibrary.wiley.com/doi/10.1002/joc.5086) and processed to the resolution of one by one degree. 

**Human-induced Landscape Data.** Human-induced landscape data were obtained from [History Database of the Global Environment (HYDE)](https://www.pbl.nl/en/publications/new-anthropogenic-land-use-estimates-for-the-holocene-hyde-32) and processed to the resolution of one by one degree.

# Files in `Database`

`All_Communities_Filtered.csv` (large file) contains community composition data for all grids from 1970 to 2021, including all 470 species in the study. 

`Anthromes_Grid_Years_Prop.csv` is processed from the HYDE data on human-induced landscapes within each one by one grid. Each landscape type (column `Anthrome`) is calculated as proportions of the total land area of the grid (column `AREA_SQ_KM`), in the column `Coverage`. Data was processed from openly available data with the script `2_GenerateCommunityData/4_Process_HYDE_Data.R`.

`Bioclim.csv` is processed from the WorldClim2 data on bioclimatic variables within each one by one grid. All columns except `year` and `ST_12` (name of the grid) hold bioclimatic variables. Data was processed from openly available data with the script `2_GenerateCommunityData/5_Process_Climate_Data.R`.

`Filtered_Funct_Data.csv` contains functional data from various sources. Columns `Beak.Length_Culmen` to `Primary.Lifestyle` are from [AVONET](https://doi.org/10.1111/ele.13898). Columns `Diet.Inv` to `Nocturnal` are from [EltonTraits 1.0](https://doi.org/10.1890/13-1917.1). Column `litter_or_clutch_size_n` is from [Myhrvold et al.](https://doi.org/10.1890/15-0846R.1). Columns `Parasite` to `NestAtt_pensile` are from [Chia et al.](https://www.nature.com/articles/s41597-023-02837-1). Column `GenLength` is from [Bird et al.](https://doi.org/10.1111/cobi.13486). See the original reference for definitions and details. See the manuscript for details on the rest of the columns.

`Grids_by_BCR.csv` categorizes each grid into corresponding BCR and avian biome (column `bioregion`).

`BBS_List_PIF.csv` is the complete species list in the study, with the common name (`english`), scientific name (`latin`), AOU number (`aou`), and the PIF adjustment factor (`PIF_adj_birds_km2`) for each species. 

All other files are shape files and their required auxiliaries used for spatial analyses. Files starting with `BBS_LatLong_strata` are one-degree grids, and files starting with `bcr_strata` are shape files for Bird Conservation Regions (BCR). All files were extracted from the package `bbsBayes2`.

# Important Note

To obtain bird communities from NABBS data, we first fit hierarchical Bayesian models with spatial autocorrelation for each of the 470 species using the package [`bbsBayes2`](https://bbsbayes.github.io/bbsBayes2/index.html)). Although we provide the code for doing so (`1_FitModels/1_Run_Model.R)` for reproducibility purposes, **this is an extremely time-consuming process conducted on high-performance computation clusters over several weeks and cannot be done on personal laptops.** Therefore, we strongly recommend users to start from `2_Calculate_CWM.R` in `2_GenerateCommunityData` to read the pre-compiled community composition data, which is supplied as `All_Communities_Filtered.csv` under `Database`, then proceed to all steps in `3_Analysis`. Likewise, we recommend users to skip `4_Process_HYDE_Data.R` and `5_Process_Climate_Data.R` in `2_GenerateCommunityData` and use the processed data supplied in `Database` to run all steps in `3_Analysis`. 

# Code

**Step 1: Fit Models (`1_FitModels`)**

`1_Run_Model.R` fits abundance for all bird species in the study.

**Step 2: Process Data (`2_GenerateCommunityData`)**

`1_Get_All_Communities.R`  combines all single-species abundance data into community composition, and apply PIF adjustments to species abundance. Generates `All_Communities_Filtered.csv` (supplied in `Database`).

`2_Calculate_CWM.R` calculates the community-weighted means for functional traits. Generates `CWMetrics_Filtered.csv`, `CWMetrics_Filtered_TopSpp.csv`, or `CWMetrics_Filtered_RestSpp.csv`.

`3_Calculate_Relative_Abundance.R` calculates the relative abundance of each species within a local community, using the auxiliary function supplied in `calculate_funct_distr.R`. Generates `Relative_Abundance.csv`.

`4_Process_HYDE_Data.R` processes human-induced land use data. Generates `Anthromes_Grid_Years_Prop.csv` (supplied in `Database`).

`5_Process_Climate_Data.R` processes bioclimatic data. Generates `Bioclim.csv` (supplied in `Database`).

**Step 3: Analysis (`3_Analysis`)**

`1_Read_All_Data.R` reads all required data and set up the environment. Will be automatically loaded if needed.

`2_Model_Fitting_Base.R` fits year and environmental factors to CWMs of the complete communities. 

`3_Calculate_Contribution.R` calculates species contribution to the temporal trends of CWMs.

`4_Analyze_Contribution.R` analyzes species-level contributions in local communities and generate a list of top contributors. Generates Figure 3.

`5_Model_Fitting_SubComms.R` fits year and environmental factors to CWMs of top contributors and standard contributors, then compare the results with the complete communities. Generates Figure 1C.

`6_PCA_Communities.R` conducts PCA on complete communities, top contributors, and standard contributors based on their CWMs. Generates the top panel of Figure 2A. 

`7_Trajectory_Analysis.R` analyzes functional shifts of complete communities, top contributors, and standard contributors by their trajectories in the functional space. Generates the rest of Figure 2.

# Analytical Pipeline

1. With the supplied data and code, start with `2_GenerateCommunityData/2_Calculate_CWM.R`.
2. Run files 2, 3, and 4 in `3_Analysis`.
3. After obtaining the list of top contributors, modify `2_GenerateCommunityData/2_Calculate_CWM.R` to generate CWMs of subcommunities with top contributors and standard contributors.
4. Run files 5, 6, and 7 in `3_Analysis`.
